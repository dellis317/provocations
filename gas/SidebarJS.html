<script>
/**
 * SidebarJS — Client-side logic for the AnnotationApp sidebar.
 *
 * Salesforce Lightning-styled. Includes:
 * - MediaRecorder for saving audio files to Drive
 * - Web Speech API for live transcription
 * - google.script.run calls to server-side .gs functions
 */

// ============================================================
// State
// ============================================================

var state = {
  phase: 'input',
  document: null,
  lenses: [],
  provocations: [],
  activeLens: null,
  versions: [],
  editHistory: [],
  lastSuggestions: [],
  activeTab: 'document',
  isLoading: false,
  loadingMessage: '',

  // Voice
  recognition: null,
  isRecording: false,
  interimTranscript: '',
  activeProvocationId: null,

  // Audio recording (MediaRecorder)
  mediaRecorder: null,
  audioChunks: []
};

// ============================================================
// Initialization
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
  initVoiceRecognition();
  initMediaRecorder();

  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.hasApiKey) {
        showToast('Configure your Gemini API key in AnnotationApp > Settings.', 'info');
      }
      tryLoadCurrentDoc();
    })
    .withFailureHandler(function(err) {
      showToast('Initialization error: ' + err.message, 'error');
    })
    .getConfigState();
});

function tryLoadCurrentDoc() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.content && result.content.trim()) {
        document.getElementById('input-text').value = result.content;
        document.getElementById('input-source-label').textContent = 'Loaded from: ' + result.name;
      }
    })
    .withFailureHandler(function() {})
    .getCurrentDocContent();
}

// ============================================================
// Phase: Input
// ============================================================

function startAnalysis() {
  var text = document.getElementById('input-text').value.trim();
  var objective = document.getElementById('input-objective').value.trim();

  if (!text) {
    showToast('Please enter some text to analyze.', 'error');
    return;
  }

  state.document = { text: text, objective: objective || 'Create a compelling document' };
  setPhase('loading');
  setLoading(true, 'Analyzing through multiple lenses...');

  google.script.run
    .withSuccessHandler(function(result) {
      state.document.id = result.documentId;
      state.lenses = result.lenses || [];
      state.provocations = result.provocations || [];
      state.versions = [{ text: text, description: 'Initial document', timestamp: Date.now() }];

      if (result.warnings) {
        result.warnings.forEach(function(w) { showToast(w.message, 'info'); });
      }

      setLoading(false);
      setPhase('workspace');
      switchTab('document');
    })
    .withFailureHandler(function(err) {
      setLoading(false);
      setPhase('input');
      showToast('Analysis failed: ' + err.message, 'error');
    })
    .analyzeText({ text: text });
}

function loadFromDrive() {
  google.script.run.showDrivePicker();
}

// ============================================================
// Phase: Workspace
// ============================================================

function switchTab(tabName) {
  state.activeTab = tabName;

  document.querySelectorAll('.slds-tab').forEach(function(t) {
    t.classList.toggle('slds-is-active', t.dataset.tab === tabName);
  });

  document.querySelectorAll('.tab-panel').forEach(function(p) {
    p.classList.toggle('active', p.id === 'panel-' + tabName);
  });

  if (tabName === 'document') renderDocument();
  if (tabName === 'provocations') renderProvocations();
  if (tabName === 'lenses') renderLenses();
  if (tabName === 'versions') renderVersions();
}

// ============================================================
// Document Tab
// ============================================================

function renderDocument() {
  var container = document.getElementById('document-content');
  if (!state.document) return;

  container.innerHTML =
    '<div class="slds-form-element">' +
      '<label>Objective</label>' +
      '<input type="text" id="doc-objective" value="' + escapeHtml(state.document.objective || '') + '" ' +
        'placeholder="What is this document for?" />' +
    '</div>' +
    '<div class="slds-form-element">' +
      '<div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">' +
        '<label style="margin:0">Document</label>' +
        '<div class="slds-grid slds-gap_x-small">' +
          '<button class="slds-button_icon" onclick="voiceAppend()" title="Dictate">' +
            '<span id="doc-voice-icon">&#x1F3A4;</span>' +
          '</button>' +
        '</div>' +
      '</div>' +
      '<textarea id="doc-text" class="document-area" rows="12">' +
        escapeHtml(state.document.text) +
      '</textarea>' +
      '<div id="doc-interim" class="interim-transcript hidden"></div>' +
    '</div>' +
    '<div class="slds-form-element">' +
      '<label>Instruction</label>' +
      '<div class="slds-grid slds-gap_x-small">' +
        '<input type="text" id="doc-instruction" placeholder="e.g., Expand the introduction, Make it more concise..." ' +
          'onkeydown="if(event.key===\'Enter\')applyInstruction()" />' +
        '<button class="slds-button slds-button_brand slds-button_small" onclick="applyInstruction()">Apply</button>' +
      '</div>' +
    '</div>' +
    renderSuggestions() +
    '<div class="slds-grid slds-gap_x-small slds-m-top_x-small">' +
      '<button class="slds-button slds-button_small" onclick="reanalyze()">Re-analyze</button>' +
      '<button class="slds-button slds-button_small" onclick="writeToDoc()">Write to Doc</button>' +
      '<button class="slds-button slds-button_small slds-button_success" onclick="saveToDrive()">Save to Drive</button>' +
    '</div>';
}

function renderSuggestions() {
  if (!state.lastSuggestions || state.lastSuggestions.length === 0) return '';

  var html = '<div class="slds-card slds-m-top_x-small"><div class="slds-card__header"><span class="slds-card__header-title">Suggestions</span></div><div class="slds-card__body">';
  state.lastSuggestions.forEach(function(s) {
    html += '<div style="margin-bottom:4px;cursor:pointer;color:var(--brand-primary)" ' +
      'onclick="document.getElementById(\'doc-instruction\').value=\'' + escapeHtml(s).replace(/'/g, "\\'") + '\'">' +
      '&rarr; ' + escapeHtml(s) + '</div>';
  });
  html += '</div></div>';
  return html;
}

function applyInstruction() {
  var instruction = document.getElementById('doc-instruction').value.trim();
  if (!instruction) { showToast('Enter an instruction first.', 'error'); return; }

  var docText = document.getElementById('doc-text').value;
  var objective = document.getElementById('doc-objective').value || state.document.objective;
  var textarea = document.getElementById('doc-text');
  var selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd) || undefined;

  setLoading(true, 'Evolving document...');

  google.script.run
    .withSuccessHandler(function(result) {
      state.document.text = result.document;
      state.document.objective = objective;
      state.versions.push({ text: result.document, description: result.summary || instruction, timestamp: Date.now() });
      state.editHistory.push({ instruction: instruction, instructionType: result.instructionType || 'general', summary: result.summary || 'Updated', timestamp: Date.now() });
      state.lastSuggestions = result.suggestions || [];
      setLoading(false);
      renderDocument();
      document.getElementById('doc-instruction').value = '';
      showToast(result.summary || 'Document updated', 'success');
    })
    .withFailureHandler(function(err) {
      setLoading(false);
      showToast('Update failed: ' + err.message, 'error');
    })
    .writeDocument({
      document: docText, objective: objective, instruction: instruction,
      selectedText: selectedText, activeLens: state.activeLens, editHistory: state.editHistory.slice(-10)
    });
}

function reanalyze() {
  var text = document.getElementById('doc-text').value;
  setLoading(true, 'Re-analyzing...');
  google.script.run
    .withSuccessHandler(function(result) {
      state.lenses = result.lenses || [];
      state.provocations = result.provocations || [];
      setLoading(false);
      showToast('Analysis updated with ' + state.provocations.length + ' provocations', 'success');
      switchTab('provocations');
    })
    .withFailureHandler(function(err) { setLoading(false); showToast('Re-analysis failed: ' + err.message, 'error'); })
    .analyzeText({ text: text });
}

function writeToDoc() {
  var text = document.getElementById('doc-text').value;
  setLoading(true, 'Writing to document...');
  google.script.run
    .withSuccessHandler(function() { setLoading(false); showToast('Document updated!', 'success'); })
    .withFailureHandler(function(err) { setLoading(false); showToast('Write failed: ' + err.message, 'error'); })
    .updateCurrentDoc(text);
}

function saveToDrive() {
  var text = document.getElementById('doc-text').value;
  var objective = document.getElementById('doc-objective').value || state.document.objective || '';
  setLoading(true, 'Saving to Drive...');
  google.script.run
    .withSuccessHandler(function(result) {
      setLoading(false);
      showToast('Saved: ' + result.fileName, 'success');
    })
    .withFailureHandler(function(err) { setLoading(false); showToast('Save failed: ' + err.message, 'error'); })
    .saveDocumentToDrive(text, objective.substring(0, 50) || 'Document', objective);
}

// ============================================================
// Provocations Tab
// ============================================================

var PROVOCATION_TYPES = ['opportunity', 'fallacy', 'alternative'];

function renderProvocations() {
  var container = document.getElementById('provocations-content');
  if (state.provocations.length === 0) {
    container.innerHTML = '<p class="slds-text-color_weak slds-text-center slds-m-top_small">No provocations yet. Analyze a document first.</p>';
    return;
  }

  var html = '<div class="slds-pill-container slds-m-bottom_small">' +
    '<button class="slds-pill' + (!state.activeLens ? ' slds-is-selected' : '') + '" onclick="setActiveLens(null)">All</button>';

  PROVOCATION_TYPES.forEach(function(t) {
    var count = state.provocations.filter(function(p) { return p.type === t; }).length;
    html += '<button class="slds-pill' + (state.activeLens === t ? ' slds-is-selected' : '') +
      '" onclick="setActiveLens(\'' + t + '\')">' + capitalize(t) + ' (' + count + ')</button>';
  });
  html += '</div>';

  var filtered = state.provocations;
  if (state.activeLens && PROVOCATION_TYPES.indexOf(state.activeLens) !== -1) {
    filtered = filtered.filter(function(p) { return p.type === state.activeLens; });
  }

  filtered.forEach(function(p) {
    var isAddressed = p.status === 'addressed';
    html += '<div class="slds-card provocation-card' + (isAddressed ? ' addressed' : '') +
      '" data-type="' + p.type + '" id="prov-' + p.id + '">' +
      '<div class="slds-card__header">' +
        '<span class="provocation-type ' + p.type + '">' + p.type + '</span>' +
        '<button class="voice-btn' + (state.isRecording && state.activeProvocationId === p.id ? ' recording' : '') +
          '" onclick="voiceRespondToProvocation(\'' + p.id + '\')" title="Respond with voice">' +
          (state.isRecording && state.activeProvocationId === p.id ? '&#x25A0;' : '&#x1F3A4;') +
        '</button>' +
      '</div>' +
      '<div class="slds-card__header-title">' + escapeHtml(p.title) + '</div>' +
      '<div class="slds-card__body slds-m-top_xx-small">' + escapeHtml(p.content) + '</div>' +
      (p.sourceExcerpt ? '<div class="provocation-excerpt">"' + escapeHtml(p.sourceExcerpt) + '"</div>' : '') +
      '<div id="prov-interim-' + p.id + '" class="interim-transcript hidden"></div>' +
      '<div class="provocation-actions">' +
        '<button class="slds-button slds-button_small" onclick="respondToProvocation(\'' + p.id + '\')">Respond</button>' +
        '<button class="slds-button slds-button_small" onclick="dismissProvocation(\'' + p.id + '\')">Dismiss</button>' +
      '</div>' +
    '</div>';
  });

  container.innerHTML = html;
}

function setActiveLens(lens) { state.activeLens = lens; renderProvocations(); }

function respondToProvocation(provId) {
  var prov = state.provocations.find(function(p) { return p.id === provId; });
  if (!prov) return;
  var response = prompt('Respond to: "' + prov.title + '"\n\nType your response:');
  if (!response || !response.trim()) return;
  applyProvocationResponse(provId, response.trim());
}

function applyProvocationResponse(provId, transcript) {
  var prov = state.provocations.find(function(p) { return p.id === provId; });
  if (!prov || !state.document) return;

  var docText = document.getElementById('doc-text')
    ? document.getElementById('doc-text').value : state.document.text;

  // Save transcript to Drive
  google.script.run.saveTranscript(transcript, prov.title, {
    provocationTitle: prov.title, provocationId: prov.id,
    documentObjective: state.document.objective
  });

  setLoading(true, 'Addressing provocation...');

  google.script.run
    .withSuccessHandler(function(result) {
      state.document.text = result.document;
      state.versions.push({ text: result.document, description: 'Addressed: ' + prov.title, timestamp: Date.now() });
      state.editHistory.push({ instruction: transcript, instructionType: result.instructionType || 'general', summary: result.summary || 'Provocation addressed', timestamp: Date.now() });
      state.lastSuggestions = result.suggestions || [];
      prov.status = 'addressed';
      setLoading(false);
      renderProvocations();
      showToast(result.summary || 'Provocation addressed', 'success');
    })
    .withFailureHandler(function(err) { setLoading(false); showToast('Failed: ' + err.message, 'error'); })
    .writeDocument({
      document: docText, objective: state.document.objective || '', instruction: transcript,
      provocation: { type: prov.type, title: prov.title, content: prov.content, sourceExcerpt: prov.sourceExcerpt },
      activeLens: state.activeLens, editHistory: state.editHistory.slice(-10)
    });
}

function dismissProvocation(provId) {
  state.provocations = state.provocations.filter(function(p) { return p.id !== provId; });
  renderProvocations();
  google.script.run.trackUsage('provocation_dismiss');
}

// ============================================================
// Lenses Tab
// ============================================================

function renderLenses() {
  var container = document.getElementById('lenses-content');
  if (state.lenses.length === 0) {
    container.innerHTML = '<p class="slds-text-color_weak slds-text-center slds-m-top_small">No lenses yet.</p>';
    return;
  }

  var html = '';
  state.lenses.forEach(function(lens) {
    html += '<div class="slds-card">' +
      '<div class="slds-card__header">' +
        '<span class="slds-card__header-title">' + escapeHtml(lens.title) + '</span>' +
        '<span class="slds-pill slds-is-selected" style="cursor:default">' + lens.type + '</span>' +
      '</div>' +
      '<div class="slds-card__body">' + escapeHtml(lens.summary) + '</div>';

    if (lens.keyPoints && lens.keyPoints.length > 0) {
      html += '<ul style="margin-top:6px;padding-left:16px;font-size:12px;color:var(--color-text-secondary)">';
      lens.keyPoints.forEach(function(kp) { html += '<li>' + escapeHtml(kp) + '</li>'; });
      html += '</ul>';
    }
    html += '</div>';
  });

  container.innerHTML = html;
}

// ============================================================
// Versions Tab
// ============================================================

function renderVersions() {
  var container = document.getElementById('versions-content');
  if (state.versions.length === 0) {
    container.innerHTML = '<p class="slds-text-color_weak slds-text-center slds-m-top_small">No versions yet.</p>';
    return;
  }

  var html = '';
  for (var i = state.versions.length - 1; i >= 0; i--) {
    var v = state.versions[i];
    var time = new Date(v.timestamp).toLocaleTimeString();
    html += '<div class="version-item" onclick="restoreVersion(' + i + ')">' +
      '<div class="slds-grid slds-grid_align-spread">' +
        '<span class="version-desc">' + escapeHtml(v.description) + '</span>' +
        '<span class="version-time">' + time + '</span>' +
      '</div>' +
      '<div class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">' +
        escapeHtml(v.text.substring(0, 100)) + (v.text.length > 100 ? '...' : '') +
      '</div>' +
    '</div>';
  }
  container.innerHTML = html;
}

function restoreVersion(idx) {
  var version = state.versions[idx];
  if (!version) return;
  if (confirm('Restore this version? Current text will be added as a new version.')) {
    state.versions.push({ text: state.document.text, description: 'Before restore', timestamp: Date.now() });
    state.document.text = version.text;
    showToast('Version restored', 'success');
    switchTab('document');
  }
}

// ============================================================
// Voice Recognition (Web Speech API — transcription)
// ============================================================

function initVoiceRecognition() {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return;

  state.recognition = new SpeechRecognition();
  state.recognition.continuous = true;
  state.recognition.interimResults = true;
  state.recognition.lang = 'en-US';

  state.recognition.onresult = function(event) {
    var finalTranscript = '';
    var interimTranscript = '';
    for (var i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) { finalTranscript += event.results[i][0].transcript; }
      else { interimTranscript += event.results[i][0].transcript; }
    }
    if (finalTranscript) { state.interimTranscript += finalTranscript + ' '; }

    var display = state.interimTranscript + interimTranscript;
    if (state.activeProvocationId) {
      var el = document.getElementById('prov-interim-' + state.activeProvocationId);
      if (el) { el.textContent = display; el.classList.remove('hidden'); }
    } else {
      var docInterim = document.getElementById('doc-interim');
      if (docInterim) { docInterim.textContent = display; docInterim.classList.remove('hidden'); }
    }
  };

  state.recognition.onend = function() {
    var transcript = state.interimTranscript.trim();
    state.isRecording = false;
    state.interimTranscript = '';

    // Stop MediaRecorder and save audio
    if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
      state.mediaRecorder.stop();
    }

    document.querySelectorAll('.interim-transcript').forEach(function(el) { el.classList.add('hidden'); });

    if (transcript) {
      if (state.activeProvocationId) {
        applyProvocationResponse(state.activeProvocationId, transcript);
      } else {
        var docTextarea = document.getElementById('doc-text');
        if (docTextarea) {
          var current = docTextarea.value;
          docTextarea.value = current + (current.endsWith(' ') || current.endsWith('\n') ? '' : ' ') + transcript;
          state.document.text = docTextarea.value;
        }
      }
      // Save transcript file
      google.script.run.saveTranscript(transcript, 'voice-input');
    }

    state.activeProvocationId = null;
    renderProvocations();
  };

  state.recognition.onerror = function(event) {
    if (event.error === 'not-allowed') { showToast('Microphone access required.', 'error'); }
    else if (event.error === 'no-speech') { showToast('No speech detected.', 'info'); }
    state.isRecording = false;
    state.activeProvocationId = null;
  };
}

// ============================================================
// MediaRecorder (audio file capture for Drive)
// ============================================================

function initMediaRecorder() {
  // Will be initialized on first use (requires user gesture for getUserMedia)
}

function startMediaRecording() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
      state.audioChunks = [];
      state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

      state.mediaRecorder.ondataavailable = function(event) {
        if (event.data.size > 0) state.audioChunks.push(event.data);
      };

      state.mediaRecorder.onstop = function() {
        var blob = new Blob(state.audioChunks, { type: 'audio/webm' });
        stream.getTracks().forEach(function(t) { t.stop(); });

        // Convert to base64 and send to server
        var reader = new FileReader();
        reader.onloadend = function() {
          var base64 = reader.result.split(',')[1];
          google.script.run
            .withSuccessHandler(function(result) {
              // Audio saved silently
            })
            .withFailureHandler(function(err) {
              console.log('Audio save failed:', err.message);
            })
            .saveAudioFile(base64, 'audio/webm');
        };
        reader.readAsDataURL(blob);
      };

      state.mediaRecorder.start();
    })
    .catch(function(err) {
      console.log('MediaRecorder init failed:', err.message);
    });
}

function voiceRespondToProvocation(provId) {
  if (!state.recognition) { showToast('Voice not supported.', 'error'); return; }
  if (state.isRecording) { state.recognition.stop(); return; }

  state.activeProvocationId = provId;
  state.interimTranscript = '';
  state.isRecording = true;
  try {
    state.recognition.start();
    startMediaRecording();
    renderProvocations();
  } catch (e) { state.isRecording = false; showToast('Recording failed: ' + e.message, 'error'); }
}

function voiceAppend() {
  if (!state.recognition) { showToast('Voice not supported.', 'error'); return; }
  if (state.isRecording) { state.recognition.stop(); return; }

  state.activeProvocationId = null;
  state.interimTranscript = '';
  state.isRecording = true;
  try {
    state.recognition.start();
    startMediaRecording();
    var icon = document.getElementById('doc-voice-icon');
    if (icon) icon.textContent = '\u25A0';
  } catch (e) { state.isRecording = false; showToast('Recording failed: ' + e.message, 'error'); }
}

// ============================================================
// UI Helpers
// ============================================================

function setPhase(phase) {
  state.phase = phase;
  document.getElementById('phase-input').classList.toggle('hidden', phase !== 'input');
  document.getElementById('phase-loading').classList.toggle('hidden', phase !== 'loading');
  document.getElementById('phase-workspace').classList.toggle('hidden', phase !== 'workspace');
}

function setLoading(loading, message) {
  state.isLoading = loading;
  state.loadingMessage = message || 'Working...';

  var overlay = document.getElementById('phase-loading');
  if (loading && state.phase !== 'workspace') {
    overlay.innerHTML = '<div class="loading-overlay"><div class="slds-spinner"></div><span>' +
      escapeHtml(state.loadingMessage) + '</span></div>';
    overlay.classList.remove('hidden');
  }

  var inlineLoader = document.getElementById('inline-loader');
  if (inlineLoader) {
    if (loading) {
      inlineLoader.innerHTML = '<div class="slds-spinner"></div> ' + escapeHtml(message);
      inlineLoader.classList.remove('hidden');
    } else {
      inlineLoader.classList.add('hidden');
    }
  }

  document.querySelectorAll('.slds-button').forEach(function(btn) { btn.disabled = loading; });
}

function showToast(message, type) {
  type = type || 'info';
  var container = document.getElementById('toast-container');
  var toast = document.createElement('div');
  toast.className = 'slds-notify slds-notify_' + type;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(function() {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(function() { toast.remove(); }, 300);
  }, 4000);
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// ============================================================
// Feedback Pill
// ============================================================

function openFeedback() {
  google.script.run.showFeedback();
}
</script>
